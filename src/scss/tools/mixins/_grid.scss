/*

  Mixin `generate-grid`

  Mixin that generates our grid. We are using media queries with a mobile first approach. So, our first breakpoint is small, but the columns and container are not on the media queries. The next breakpoint (medium) it is inside of media-queries of previous breakpoint.

  This mixin will generate our columns and the container, considering media-queries for all the breakpoints.

  $breakpoints - map of breakpoints
  $breakpoints = $defaultBreakpoints - map of breakpoints

  Style guide: tools.mixins
*/
@mixin generate-grid($breakpoints: $defaultBreakpoints) {
  $index: 1;

  @each $key, $breakpoint in $breakpoints {
    $columns: map-get($breakpoint, columns);
    $gridSize: map-get($breakpoint, size);
    $gutter: calc-gutter-percentage($breakpoints) * $gridSize;

    @if $index == 1 {
      @include generate-grid-container($breakpoint, $breakpoints, $gutter);
      @include generate-grid-columns($breakpoint, $key, $gutter);
    } @else {
      $previousBreakpoint: map-get(get-breakpoint-by-index($breakpoints, $index - 1), size);
      @include media-gt(small, $value: $previousBreakpoint) {
        @include generate-grid-container($breakpoint, $breakpoints, $gutter);
        @include generate-grid-columns($breakpoint, $key, $gutter);
      }
    }
    $index: $index + 1;
  }
};

@mixin generate-grid-columns($breakpoint, $key, $gutter) {
  $columns: map-get($breakpoint, columns);
  $gridSize: map-get($breakpoint, size);
  $gutterRatio: $gutter / $gridSize;

  [class*='col-#{$key}-'] {
    margin-right: percentage($gutterRatio);

    &:last-child {
      margin-right: 0;
    }

    &.col-centered {
      margin: {
        right: auto;
        left: auto;
      }
    }
  }

  [class*='col-'] {
    @include flex-shrink(0);
  }

  @for $i from 1 through $columns {
    .col-#{$key}-#{$i} {
      width: percentage(($i / $columns) + ($gutterRatio / ($columns / $i)) - $gutterRatio);
    }
  }
};


@mixin generate-grid-container($breakpoint, $breakpoints, $gutterPercentage) {
  $breakpointsLength: length($breakpoints);
  $index: index(map-values($breakpoints), $breakpoint);
  $gridSize: map-get($breakpoint, size);
  $gridPadding: $gutterPercentage / 2;

  .container {
    @include flex-direction(row);
    @include flex-wrap(wrap);
    @include flexbox;

    width: 100%;
    max-width: $gridSize + px;
    margin-left: auto;
    margin-right: auto;
    padding-left: percentage($gridPadding / $gridSize);
    padding-right: percentage($gridPadding / $gridSize);

    .no-flexbox & {
      @include clearfix;

      [class*='col-'] {
        float: left;
      }
    }
  }
};

@function get-breakpoint-by-index($breakpoints, $index) {
  @return nth(map-values($breakpoints), $index);
};

@function get-breakpoint($name, $breakpoints: $defaultBreakpoints) {
  @return map-get(map-get($breakpoints, $name), size);
};

@function calc-grid-max-size($breakpoints) {
  $list: ();

  @each $key, $breakpoint in $breakpoints {
    $list: append($list, map-get($breakpoint, size) + 0, comma);
  };

  @return max($list...);
};

@function calc-gutter-percentage($breakpoints) {
  @return $gridGutter / calc-grid-max-size($breakpoints);
};

